<ng-container *ngIf="site$ | async as site; else loadingOrError">
  <!-- Mobile-first top bar -->
  <mat-toolbar color="primary" class="sticky top-0 z-10">
    <button mat-icon-button (click)="goBack()" aria-label="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <span class="ml-2 truncate">{{ site.name }}</span>

    <span class="flex-1"></span>

    <ng-container *ngIf="!editMode(); else editActions">
      <button mat-button (click)="startEdit()">Edit</button>
    </ng-container>

    <ng-template #editActions>
      <button mat-button (click)="cancelEdit()" [disabled]="saving()">Cancel</button>
      <button mat-flat-button color="accent" (click)="save(site)" [disabled]="!canSave()">Save</button>
    </ng-template>
  </mat-toolbar>

  <div class="p-4 flex flex-col gap-4 max-w-3xl mx-auto">
    <!-- View mode -->
    <ng-container *ngIf="!editMode(); else editForm">
      <mat-card>
        <mat-card-header>
          <mat-card-title class="text-base">Opening hours</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="flex flex-col gap-2 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-gray-600">Opens</span>
              <span class="font-medium">{{ site.openingHours }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-600">Closes</span>
              <span class="font-medium">{{ site.closingHours }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title class="text-base">Closed days</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="flex flex-wrap gap-2" *ngIf="site.closedDays?.length; else noClosedDays">
            <mat-chip *ngFor="let d of site.closedDays">{{ d | date:'yyyy-MM-dd' }}</mat-chip>
          </div>
          <ng-template #noClosedDays>
            <span class="text-sm text-gray-600">No closed days configured</span>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title class="text-base">Courts</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="flex flex-wrap gap-2" *ngIf="site.courts.length; else noCourts">
            <mat-chip *ngFor="let c of site.courts">Court {{ c.number }}</mat-chip>
          </div>
          <ng-template #noCourts>
            <span class="text-sm text-gray-600">No courts configured</span>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title class="text-base">Revenue</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="flex items-baseline gap-2">
            <span class="text-xl font-semibold">{{ site.revenue | currency:'EUR':'symbol':'1.0-0' }}</span>
            <span class="text-xs text-gray-600">(demo)</span>
          </div>
        </mat-card-content>
      </mat-card>
    </ng-container>

    <!-- Edit mode -->
    <ng-template #editForm>
      <form [formGroup]="form" class="flex flex-col gap-4">
        <mat-card>
          <mat-card-header>
            <mat-card-title class="text-base">General</mat-card-title>
          </mat-card-header>
          <mat-card-content class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Name</mat-label>
              <input matInput formControlName="name" placeholder="Site name" />
              <mat-error *ngIf="form.controls.name.touched && form.controls.name.invalid">
                Name is required (min 2 chars)
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Revenue</mat-label>
              <input matInput type="number" formControlName="revenue" />
              <mat-error *ngIf="form.controls.revenue.touched && form.controls.revenue.invalid">
                Revenue must be a positive number
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Opening hours</mat-label>
              <input matInput formControlName="openingHours" placeholder="HH:mm" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Closing hours</mat-label>
              <input matInput formControlName="closingHours" placeholder="HH:mm" />
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <mat-card>
          <mat-card-header>
            <mat-card-title class="text-base">Closed days</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Closed days (comma separated)</mat-label>
              <input matInput formControlName="closedDays" placeholder="Sunday, Monday" />
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <mat-card>
          <mat-card-header>
            <mat-card-title class="text-base">Courts</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Courts (comma separated)</mat-label>
              <input matInput formControlName="courts" placeholder="Court A, Court B" />
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <div class="flex items-center gap-3">
          <mat-progress-spinner *ngIf="saving()" mode="indeterminate" diameter="20"></mat-progress-spinner>
          <span *ngIf="saving()" class="text-sm text-gray-600">Saving…</span>
        </div>
      </form>
    </ng-template>
  </div>
</ng-container>

<ng-template #loadingOrError>
  <div class="p-4 flex items-center justify-center" *ngIf="loading(); else notFound">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>

  <ng-template #notFound>
    <div class="p-4 max-w-md mx-auto">
      <mat-card>
        <mat-card-header>
          <mat-card-title class="text-base">Site not found</mat-card-title>
        </mat-card-header>
        <mat-card-content class="text-sm text-gray-600">
          The requested site doesn’t exist (or the id is invalid).
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-flat-button color="primary" (click)="goBack()">Back to list</button>
        </mat-card-actions>
      </mat-card>
    </div>
  </ng-template>
</ng-template>
